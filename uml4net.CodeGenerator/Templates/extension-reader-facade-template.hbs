// -------------------------------------------------------------------------------------------------
// <copyright file="ExtensionContentReaderFacade.cs" company="Starion Group S.A.">
    //
    //   Copyright (C) 2019-2025 Starion Group S.A.
    //
    //   Licensed under the Apache License, Version 2.0 (the "License");
    //   you may not use this file except in compliance with the License.
    //   You may obtain a copy of the License at
    //
    //       http://www.apache.org/licenses/LICENSE-2.0
    //
    //   Unless required by applicable law or agreed to in writing, software
    //   distributed under the License is distributed on an "AS IS" BASIS,
    //   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    //   See the License for the specific language governing permissions and
    //   limitations under the License.
    //
    // </copyright>
// ------------------------------------------------------------------------------------------------

// ------------------------------------------------------------------------------------------------
// --------THIS IS AN AUTOMATICALLY GENERATED FILE. ANY MANUAL CHANGES WILL BE OVERWRITTEN!--------
// ------------------------------------------------------------------------------------------------

namespace uml4net.{{this.Namespace}}.Readers
{
    using System;
    using System.CodeDom.Compiler;
    using System.Collections.Generic;
    using System.Xml;
    
    using Microsoft.Extensions.Logging;

    using uml4net.xmi.Readers;
    using uml4net.xmi.Settings;

    /// <summary>
    /// The <see cref="ExtensionContentReaderFacade"/> provides extension content read capabilities via <see cref="IExtensionContentReader{TContent}"/> call
    /// </summary>
    [GeneratedCode("uml4net", "latest")]
    public class ExtensionContentReaderFacade : IExtensionContentReaderFacade
    {
        /// <summary>
        /// A dictionary that contains functions that return extension content based a key that represents the type
        /// and a provided <see cref="IXmiElementCache"/>, <see cref="ILoggerFactory"/> and <see cref="XmlReader"/>
        /// </summary>
        protected readonly Dictionary<string, Func<IXmiElementCache, IXmiReaderSettings, INameSpaceResolver, ILoggerFactory, XmlReader, string, object>> readerCache;
    
        /// <summary>
        /// Initializes a new instance of the <see cref="ExtensionContentReaderFacade"/>
        /// </summary>
        public ExtensionContentReaderFacade()
        {
            this.readerCache = new Dictionary<string, Func<IXmiElementCache, IXmiReaderSettings, INameSpaceResolver, ILoggerFactory, XmlReader, string, object>>
            {
            {{ #each this.Classes as | class | }}
            ["{{ class.Name }}"] = (cache, xmiReaderSettings, nameSpaceResolver, loggerFactory, xmlReader, documentName) =>
                {
                    using var subXmlReader = xmlReader.ReadSubtree();
                    var {{ String.LowerCaseFirstLetter class.Name }}Reader = new {{ class.Name }}Reader(this, xmiReaderSettings, nameSpaceResolver, cache, loggerFactory);
                    return {{ String.LowerCaseFirstLetter class.Name }}Reader.Read(subXmlReader, documentName);
                },
            {{/each}}
            };
        }
    
        /// <summary>
        /// Queries an instance of an <see cref="IXmiElement"/> based on the position of the <see cref="XmlReader"/>. When the reader
        /// is at an XML Element and has an attribute of xmi:type, the value of that attribute is used to select the appropriate
        /// XmiElementReader from which the <see cref="IXmiElement"/> is returned.
        /// </summary>
        /// <param name="xmlReader">
        /// An instance of <see cref="XmlReader"/>
        /// </param>
        /// <param name="xmiReaderSettings" >
        /// The <see cref="IXmiReaderSettings"/> used to configure reading
        /// </param>
        /// <param name="nameSpaceResolver">
        /// The (injected) <see cref="INameSpaceResolver"/> used to resolve a namespace to one of the
        /// <see cref="SupportedNamespaces"/>
        /// </param>
        /// <param name="cache">The <see cref="IXmiElementCache"/> that provides cached <see cref="IXmiElement"/> retriveal</param>
        /// <param name="documentName">The name of the document that is currently read</param>
        /// <param name="loggerFactory">
        /// The <see cref="ILoggerFactory"/> to set up logging
        /// </param>
        /// <returns>
        /// an instance of <typeparamref name="TContent "/>
        /// </returns>
        /// <typeparam name="TContent">Any supported type</typeparam>
        /// <exception cref="InvalidOperationException">
        /// thrown when the xmi:type is not supported and noXmiElementReader was found
        /// </exception>
        public TContent QueryExtensionContent<TContent>(XmlReader xmlReader, IXmiReaderSettings xmiReaderSettings, INameSpaceResolver nameSpaceResolver, IXmiElementCache cache, string documentName, ILoggerFactory loggerFactory)
        {
            if (xmlReader == null)
            {
                throw new ArgumentNullException(nameof(xmlReader));
            }
            
            if (xmiReaderSettings == null)
            {
                throw new ArgumentNullException(nameof(xmiReaderSettings));
            }
            
            if (nameSpaceResolver == null)
            {
                throw new ArgumentNullException(nameof(nameSpaceResolver));
            }

            if (cache == null)
            {
                throw new ArgumentNullException(nameof(cache));
            }

            var type = typeof(TContent);
            var extensionTypeName = type.IsInterface ? xmlReader.LocalName : typeof(TContent).Name;

            if (this.readerCache.TryGetValue(extensionTypeName, out var readerFactory)
                && readerFactory(cache, xmiReaderSettings, nameSpaceResolver, loggerFactory, xmlReader, documentName) is TContent content)
            {
                return content;
            }
            
            throw new InvalidOperationException($"No reader found for extension type - {extensionTypeName}");
        }
    }
}

// ------------------------------------------------------------------------------------------------
// --------THIS IS AN AUTOMATICALLY GENERATED FILE. ANY MANUAL CHANGES WILL BE OVERWRITTEN!--------
// ------------------------------------------------------------------------------------------------
